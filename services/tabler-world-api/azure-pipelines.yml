# build number
name: $(VERSION).$(rev:r)

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: VERSION
    value: 1.4
  - name: PACKAGE_DIR
    value: $(System.DefaultWorkingDirectory)/services/tabler-world-api

  - group: AWS Germany
  - group: ENV Germany Shared

pr:
  branches:
    exclude:
      - '*'

trigger:
  branches:
    include:
      - release/v1.4

  paths:
    include:
      - packages/**/src/*
      - services/tabler-world-api/src/*
      - services/tabler-world-api/azure-pipelines.yml

stages:
- stage: deploy
  jobs:
  - deployment: dev
    environment: tabler-world-dev
    variables:
      - group: ENV Germany DEV
    strategy:
      runOnce:
        deploy:
          steps:
            - template: ../devops/service.yml
              parameters:
                PACKAGE_DIR: $(PACKAGE_DIR)
                INFRASTRUCTURE_RELEASE_CHANNEL: $(INFRASTRUCTURE_RELEASE_CHANNEL)
                AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

            - task: AmazonWebServices.aws-vsts-tools.LambdaInvokeFunction.LambdaInvokeFunction@1
              displayName: 'db update'
              inputs:
                awsCredentials: AWS
                regionName: $(AWS_DEFAULT_REGION)
                functionName: 'tabler-world-api-$(INFRASTRUCTURE_RELEASE_CHANNEL)-database-update'
                logRequest: true
                logResponse: true


  - deployment: test
    environment: tabler-world-test
    variables:
      - group: ENV Germany TEST
    dependsOn: dev
    strategy:
      runOnce:
        deploy:
          steps:
            - template: ../devops/service.yml
              parameters:
                PACKAGE_DIR: $(PACKAGE_DIR)
                INFRASTRUCTURE_RELEASE_CHANNEL: $(INFRASTRUCTURE_RELEASE_CHANNEL)
                AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

            - task: AmazonWebServices.aws-vsts-tools.LambdaInvokeFunction.LambdaInvokeFunction@1
              displayName: 'db update'
              inputs:
                awsCredentials: AWS
                regionName: $(AWS_DEFAULT_REGION)
                functionName: 'tabler-world-api-$(INFRASTRUCTURE_RELEASE_CHANNEL)-database-update'
                logRequest: true
                logResponse: true


  - deployment: prod
    environment: tabler-world-prod
    variables:
      - group: ENV Germany PROD
    dependsOn: test
    strategy:
      runOnce:
        deploy:
          steps:
            - template: ../devops/service.yml
              parameters:
                PACKAGE_DIR: $(PACKAGE_DIR)
                INFRASTRUCTURE_RELEASE_CHANNEL: $(INFRASTRUCTURE_RELEASE_CHANNEL)
                AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

            - task: AmazonWebServices.aws-vsts-tools.LambdaInvokeFunction.LambdaInvokeFunction@1
              displayName: 'db update'
              inputs:
                awsCredentials: AWS
                regionName: $(AWS_DEFAULT_REGION)
                functionName: 'tabler-world-api-$(INFRASTRUCTURE_RELEASE_CHANNEL)-database-update'
                logRequest: true
                logResponse: true